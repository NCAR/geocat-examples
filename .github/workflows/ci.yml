name: CI
on:
  pull_request:
  schedule:
    - cron: '0 0 * * *' # Daily “At 00:00”
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-run:
    name: Build Sphinx Docs (${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    defaults:
      run:
        shell: bash -l {0}

    strategy:
      fail-fast: false
      matrix:
        os: [ "ubuntu-latest"]
        python-version: [ "3.9", "3.10", "3.11" ]
        include:
          - os: "macos-latest"
            python-version: "3.9"
          - os: "macos-latest"
            python-version: "3.11"

    steps:
    - name: checkout
      uses: actions/checkout@v4
    - name: Set environment variables
      run: |
        echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
    - name: setup micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
         environment-name: geocat-examples
         environment-file: conda_environment.yml
         cache-environment: true
         cache-environment-key: "${{runner.os}}-${{runner.arch}}-py${{matrix.python-version}}-${{env.TODAY}}"
         create-args: >-
           python=${{matrix.python-version}}
    - name: make html
      uses: nick-fields/retry@v2
      with:
         timeout_minutes: 40
         max_attempts: 3
         command: |
            cd docs
            conda info
            conda list
            make html
